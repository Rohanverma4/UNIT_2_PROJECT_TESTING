<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link
			rel="stylesheet"
			href="https://fonts.googleapis.com/icon?family=Material+Icons"
		/>
		<link rel="stylesheet" href="../HOMEPAGE_CAROUSEL/modalBox.css" />
		<link rel="stylesheet" href="../HOMEPAGE_CAROUSEL/navbarSidePanel.css" />
		<link rel="stylesheet" href="../HOMEPAGE_CAROUSEL/connected.css" />
		<link rel="stylesheet" href="../GLOBAL_FILES/style/patnar.css" />
		<link rel="stylesheet" href="../GLOBAL_FILES/style/contact.css" />
		<link rel="stylesheet" href="./ordersModal.css" />
		<link
			rel="stylesheet"
			href="https://fonts.googleapis.com/icon?family=Material+Icons"
		/>
		<title>Pulse Pharmacy - Cart</title>
	</head>
	<style>
		#wrapper {
			display: flex;
			padding: 10px;
			margin-top: 7%;
			justify-content: center;
			align-items: center;
			gap: 20px;
		}
		#productDiv {
			/* border: 1px solid rgb(0, 0, 0); */
			width: 50%;
			display: flex;
			flex-direction: column;
			gap: 10px;
			padding: 10px;
		}
		#productDiv > div {
			border: 1px solid rgb(180, 180, 180);
			height: fit-content;
			display: flex;
			justify-content: flex-start;
			align-items: top;
			gap: 20px;
			padding: 10px;
			position: relative;
		}
		#checkoutDiv {
			display: flex;
			/* border: 1px solid red; */
			width: fit-content;
		}
		#productDiv > div > img {
			max-width: 80px;
			height: 100px;
		}

		#productDiv > div > div {
			/* border: 1px solid red; */
			position: relative;
			width: fit-content;
		}

		.insideProductDiv h4 {
			margin: 0;
			color: rgb(29, 29, 29);
		}
		.insideProductDiv p {
			margin: 5px 0 0 0;
			font-size: 15px;
			color: rgb(71, 71, 71);
		}
		.insideProductDiv i {
			position: absolute;
			bottom: 10px;
			right: 10px;
			color: grey;
		}
		.insideProductDiv i:hover {
			cursor: pointer;
		}
		#numOfItems {
			/* border: 1px solid black; */
			width: max-content;
			position: absolute;
			top: 10px;
			right: 10px;
			padding: 4.5px 10px;
			background-color: gray;
			color: white;
			border-radius: 5px;
		}
		#checkoutDiv {
			border: 1px solid rgb(199, 199, 199);
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			width: 25%;
			position: relative;
		}
		#checkoutDiv button {
			width: 100% !important;
			padding: 10px 0;
			font-size: 18px;
		}
		#checkoutDiv p {
			position: relative;
		}
		#checkoutDiv p span {
			position: absolute;
			right: 0;
			line-height: 22px;
		}
		.selectTag {
			position: absolute;
			right: 10px;
			top: 45%;
			/* border: 1px solid black; */
			background-color: tomato;
			border-radius: 5px;
			border: none;
			padding: 5px 0;
			color: white;

			display: block;
			max-height: min-content;
		}
		#cartAnchor {
			display: none;
		}
	</style>
	<body>
		<div id="navbarDiv"></div>
		<main>
			<!-- Main code -->
			<div id="wrapper">
				<div id="productDiv"></div>
				<div id="checkoutDiv">
					<button id="applyCupon">Apply Cupon</button>
					<!-- Modal Box Content -->
					<div id="myOrdersModal" class="ordersModal">
						<!-- Modal content -->
						<div class="modal-content">
							<div class="modal-header">
								<h2>Choose Cupon</h2>
							</div>
							<div class="modal-body">
								<ul id="cuponSelector">
									<li>
										<input type="radio" name="radioCupon" id="masai30" />
										<label for="masai30">MASAI 30 (flat 30% off)</label
										>
									</li>
									<li>
										<input type="radio" name="radioCupon" id="masai50" />
										<label for="masai50">MASAI 50 (flat 50% off)</label
										>
									</li>
									<li>
										<input type="radio" name="radioCupon" id="masai10" />
										<label for="masai10">MASAI 10 (flat 10% off)</label
										>
									</li>
								</ul>
								<input
									type="text"
									id="inputCupon"
									placeholder="Enter Your Cupon"
								/>
								<button id="applyCuponModal">Apply</button>
								<button class="close">Close</span>
							</div>
						</div>
					</div>

					<!-- Main CONTENT -->
					<div id="orderSummary">
						<h3>Order Summary</h3>
						<p id="itemsPrice">
							Items <span class="checkoutDivSpan">845</span>
						</p>
						<p id="deliveryFees">
							Delivery Fees <span class="checkoutDivSpan">15</span>
						</p>
						<p id="totalItemsPrice">
							Total <span class="checkoutDivSpan">860</span>
						</p>
					</div>
					<button id="proceed">Proceed</button>
				</div>
			</div>
		</main>
		<footer>
			<div id="contactInfo"></div>
			<div id="partnerSection"></div>
			<div id="aboutPara"></div>
		</footer>
	</body>
</html>
<script>
	let products = JSON.parse(localStorage.getItem("addedProducts")) || [];
	var productDiv = document.getElementById("productDiv");

	// KEEPING IT GLOBALLY
	let totalElemsCounter = {};
	for (let elem of products) {
		totalElemsCounter[elem.name] = totalElemsCounter[elem.name]
			? totalElemsCounter[elem.name] + 1
			: 1;
	}

	//FILTERING OUT UNIQUE VALUES
	products = Array.from(new Set(products.map((a) => a.name))).map((name) => {
		return products.find((a) => a.name === name);
	});

	let initialPrice = 0;
	for (let i = 0; i < products.length; i++) {
		initialPrice += products[i].price * totalElemsCounter[products[i].name];
	}
	localStorage.setItem("totalItemsPrice", initialPrice);

	function appendProducts(products) {
		//Total Number Of Elements

		//Appending Prices
		var itemPrice = document.querySelector("#itemsPrice > span");
		var deliveryFees = document.querySelector("#deliveryFees > span");
		var totalPrice = document.querySelector("#totalItemsPrice > span");
		itemPrice.textContent = initialPrice;
		deliveryFees.textContent = initialPrice >= 500 ? 0 : 15;
		totalPrice.textContent = initialPrice + Number(deliveryFees.textContent);

		//Products Mapping
		products.map((item) => {
			var mainDiv = document.createElement("div");
			var textDiv = document.createElement("div");
			var h4Tag = document.createElement("h4");
			var priceTag = document.createElement("p");
			var imgTag = document.createElement("img");
			var counterDiv = document.createElement("p");
			var deleteIcon = document.createElement("i");
			var selectTag = document.createElement("select");

			//VALUES INSIDE SELECT TAG
			selectTag.innerHTML += `<option>Add More</option>`;
			for (let i = 0; i < 100; i++) {
				selectTag.innerHTML += `<option value="${i}">${i}</option>`;
			}
			//Select Tag event listener
			selectTag.addEventListener("change", () => {
				selectTagFunction(item, event);
			});

			// Delete Icon EVENT LISTENER;
			deleteIcon.addEventListener("click", () => {
				deleteProduct(item, event);
			});

			//set attributes
			selectTag.setAttribute("class", "selectTag");
			deleteIcon.setAttribute("class", "material-icons");
			deleteIcon.innerText += "delete";
			counterDiv.textContent = `Total items: ${totalElemsCounter[item.name]}`;
			counterDiv.setAttribute("id", "numOfItems");
			imgTag.setAttribute("src", item.img_src);
			imgTag.setAttribute("class", "galleryCellImg");
			h4Tag.textContent = item.name;
			priceTag.textContent = `Price: ${item.price}`;
			textDiv.setAttribute("class", "galleryTextDiv");

			mainDiv.setAttribute("class", "insideProductDiv");
			textDiv.append(h4Tag, priceTag);
			mainDiv.append(imgTag, textDiv, counterDiv, selectTag, deleteIcon);
			productDiv.append(mainDiv);

			// console.log(flkty);
		});
	}
	//SELECT TAG EVENT FUNCTION
	function selectTagFunction(item, event) {
		let selectTagValue = event.target.value;
		if (selectTagValue === "Add More") return;
		if (selectTagValue == 0) {
			let newProducts = products.filter((c) => c.name !== item.name);
			localStorage.setItem("addedProducts", JSON.stringify(newProducts));
			window.location.reload();
		} else {
			event.target.parentNode.childNodes[2].textContent = `Total items: ${selectTagValue}`;
			totalElemsCounter[item.name] = +selectTagValue;
			initialPrice = 0;
			for (let i = 0; i < products.length; i++) {
				initialPrice += products[i].price * totalElemsCounter[products[i].name];
			}
			document.querySelector("#itemsPrice > span").textContent = initialPrice;
			document.querySelector("#deliveryFees > span").textContent =
				initialPrice >= 500 ? 0 : 15;
			document.querySelector("#totalItemsPrice > span").textContent =
				initialPrice +
				Number(document.querySelector("#deliveryFees > span").textContent);
		}
		localStorage.setItem("totalItemsPrice", initialPrice);
	}

	//DELETE ICON EVENT FUNCTION
	function deleteProduct(item, event) {
		// event.target.parentNode.remove();
		let newProducts = products.filter((c) => c.name !== item.name);
		console.log(`logger`);
		console.log(products);
		console.log(newProducts);
		localStorage.setItem("addedProducts", JSON.stringify(newProducts));
		// productDiv.innerHTML = "";
		// setTimeout(() => {
		// 	appendProducts(newProducts);
		// }, 10);
		window.location.reload();
	}
	document.getElementById("proceed").addEventListener("click", () => {
		window.location.href = "/ORDER_SECTION/checkoutPage.html";
	})
	appendProducts(products);

	console.log(products);
</script>
<script src="../GLOBAL_FILES/js/navDom.js"></script>
<script src="../GLOBAL_FILES/js/about.js"></script>
<script src="../GLOBAL_FILES/js/contact.js"></script>
<script src="../GLOBAL_FILES/js/patnar.js"></script>
<script src="ordersModalScript.js"></script>
